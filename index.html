<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>GameO X</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style type="text/tailwindcss">
        @layer base {
            :root {
                --background: 240 100% 99%; --foreground: 222.2 84% 4.9%; --card: 0 0% 100%; --card-foreground: 222.2 84% 4.9%; --popover: 0 0% 100%; --popover-foreground: 222.2 84% 4.9%; --primary: 349.5 86.2% 56.1%; --primary-foreground: 355.7 100% 97.3%; --secondary: 47.9 95.8% 53.1%; --secondary-foreground: 24 9.8% 10%; --muted: 210 40% 96.1%; --muted-foreground: 215.4 16.3% 46.9%; --border: 214.3 31.8% 91.4%; --input: 214.3 31.8% 91.4%; --ring: 222.2 84% 4.9%;
            }
            .dark {
                --background: 222 47% 11%; --foreground: 210 40% 98%; --card: 222 47% 15%; --card-foreground: 210 40% 98%; --popover: 222 47% 11%; --popover-foreground: 210 40% 98%; --primary: 349.5 86.2% 56.1%; --primary-foreground: 355.7 100% 97.3%; --secondary: 47.9 95.8% 53.1%; --secondary-foreground: 24 9.8% 10%; --muted: 222 47% 15%; --muted-foreground: 215 20.2% 65.1%; --border: 217.2 32.6% 27.5%; --input: 217.2 32.6% 27.5%; --ring: 212.7 26.8% 83.9%;
            }
        }
    </style>
    <script>
        tailwind.config = { darkMode: "class", theme: { extend: { colors: { background: "hsl(var(--background))", foreground: "hsl(var(--foreground))", card: { DEFAULT: "hsl(var(--card))", foreground: "hsl(var(--card-foreground))" }, popover: { DEFAULT: "hsl(var(--popover))", foreground: "hsl(var(--popover-foreground))" }, primary: { DEFAULT: "hsl(var(--primary))", foreground: "hsl(var(--primary-foreground))" }, secondary: { DEFAULT: "hsl(var(--secondary))", foreground: "hsl(var(--secondary-foreground))" }, muted: { DEFAULT: "hsl(var(--muted))", foreground: "hsl(var(--muted-foreground))" }, border: "hsl(var(--border))", input: "hsl(var(--input))", ring: "hsl(var(--ring))", }, fontFamily: { sans: ["Poppins", "sans-serif"], display: ["Fredoka One", "cursive"] }, }, }, };
    </script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Fredoka+One&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <style> body { min-height: 100vh; } </style>
</head>
<body class="bg-background font-sans text-foreground">
    
    <!-- This container is now always visible, allowing direct entry to the app -->
    <div id="main-app-container" class="min-h-screen w-full flex flex-col">
        <div class="flex-grow">
            <header class="sticky top-0 z-10 flex items-center justify-between bg-background/80 px-4 py-3 backdrop-blur-sm">
                <h1 class="font-display text-3xl text-primary">GameO X</h1>
                <div class="flex items-center gap-2">
                    <button id="theme-toggle-main" class="h-11 w-11 flex items-center justify-center rounded-full bg-card text-foreground shadow-md"><span class="material-symbols-outlined" id="theme-icon-light-main">light_mode</span><span class="material-symbols-outlined hidden" id="theme-icon-dark-main">dark_mode</span></button>
                </div>
            </header>
            <main class="p-4 pb-20">
                <div id="home-view" class="main-view">
                    <div class="relative mb-8"><span class="material-symbols-outlined pointer-events-none absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground">search</span><input id="search-bar" class="w-full rounded-full border-transparent bg-card py-3.5 pl-12 pr-4 text-foreground placeholder-muted-foreground shadow-sm focus:border-secondary focus:ring-2 focus:ring-secondary/50" placeholder="Search for games..." type="search" /></div>
                    <section class="mb-8"><h2 class="mb-4 font-display text-2xl text-foreground">Featured Videos</h2><div id="featured-carousel" class="flex snap-x snap-mandatory space-x-4 overflow-x-auto pb-4 [-ms-scrollbar-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden"></div></section>
                    <section class="mb-8"><h2 class="mb-4 font-display text-2xl text-foreground">Categories</h2><div id="categories-grid" class="grid grid-cols-2 sm:grid-cols-4 gap-4"></div></section>
                    <div id="game-sections-container"></div>
                </div>
                
                <div id="featured-view" class="main-view hidden">
                    <h2 class="mb-4 font-display text-2xl text-foreground">Featured Videos</h2>
                    <div id="featured-videos-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                </div>

                <div id="games-view" class="main-view hidden"><h2 class="mb-4 font-display text-2xl text-foreground">All Games</h2><div id="all-games-grid" class="grid grid-cols-2 gap-4"></div></div>
                
                <div id="profile-view" class="main-view hidden">
                    <div id="profile-loggedIn" class="hidden">
                        <h2 class="mb-4 font-display text-2xl text-foreground">Profile</h2>
                        <div class="p-6 bg-card rounded-xl shadow-md space-y-4">
                            <p class="text-muted-foreground">Logged in as:</p>
                            <p id="user-email" class="font-bold text-lg text-foreground break-all"></p>
                            <button id="logout-button" class="w-full rounded-lg bg-secondary py-3 font-semibold text-secondary-foreground shadow-sm hover:opacity-90">Sign Out</button>
                        </div>
                    </div>
                    <div id="profile-loggedOut">
                         <div class="w-full max-w-md mx-auto">
                            <div id="login-container" class="p-8 space-y-6 bg-card rounded-2xl shadow-xl">
                                <div class="text-center"><h1 class="font-display text-4xl text-primary">GameO X</h1><p class="text-muted-foreground">Sign in to save your progress!</p></div>
                                <form id="login-form" class="space-y-4">
                                    <input class="form-input w-full rounded-lg border-border bg-background py-3 placeholder-muted-foreground focus:ring-ring" type="email" id="login-email" placeholder="Email Address" required /><input class="form-input w-full rounded-lg border-border bg-background py-3 placeholder-muted-foreground focus:ring-ring" type="password" id="login-password" placeholder="Password" required /><p id="login-error" class="text-sm text-red-500 font-medium hidden"></p><button type="submit" class="w-full rounded-lg bg-primary py-3 font-semibold text-primary-foreground shadow-sm hover:opacity-90">Sign In</button>
                                </form>
                                <p class="text-center text-sm text-muted-foreground">Don't have an account? <a href="#" id="show-signup" class="font-semibold text-primary hover:underline">Sign Up</a></p>
                            </div>
                            <div id="signup-container" class="p-8 space-y-6 bg-card rounded-2xl shadow-xl hidden">
                                <div class="text-center"><h1 class="font-display text-4xl text-primary">GameO X</h1><p class="text-muted-foreground">Create your account</p></div>
                                <form id="signup-form" class="space-y-4">
                                    <input class="form-input w-full rounded-lg border-border bg-background py-3 placeholder-muted-foreground focus:ring-ring" type="email" id="signup-email" placeholder="Email Address" required /><input class="form-input w-full rounded-lg border-border bg-background py-3 placeholder-muted-foreground focus:ring-ring" type="password" id="signup-password" placeholder="Password (min. 6 characters)" required /><p id="signup-error" class="text-sm text-red-500 font-medium hidden"></p><button type="submit" class="w-full rounded-lg bg-primary py-3 font-semibold text-primary-foreground shadow-sm hover:opacity-90">Sign Up</button>
                                </form>
                                <p class="text-center text-sm text-muted-foreground">Already have an account? <a href="#" id="show-login" class="font-semibold text-primary hover:underline">Sign In</a></p>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
        <footer class="sticky bottom-0 bg-card/80 pt-2 backdrop-blur-sm shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
            <nav class="flex justify-around">
                <a href="#" class="nav-link flex flex-col items-center gap-1 px-2 py-1 text-primary" data-view="home"><span class="material-symbols-outlined">home</span><span class="text-xs font-medium">Home</span></a>
                <!-- New Featured Tab Added -->
                <a href="#" class="nav-link flex flex-col items-center gap-1 px-2 py-1 text-muted-foreground hover:text-primary" data-view="featured"><span class="material-symbols-outlined">subscriptions</span><span class="text-xs font-medium">Featured</span></a>
                <a href="#" class="nav-link flex flex-col items-center gap-1 px-2 py-1 text-muted-foreground hover:text-primary" data-view="games"><span class="material-symbols-outlined">casino</span><span class="text-xs font-medium">Games</span></a>
                <a href="#" class="nav-link flex flex-col items-center gap-1 px-2 py-1 text-muted-foreground hover:text-primary" data-view="profile"><span class="material-symbols-outlined">person</span><span class="text-xs font-medium">Profile</span></a>
            </nav>
        </footer>
    </div>
    
    <div id="game-viewer-modal" class="fixed inset-0 z-50 bg-black/80 hidden flex-col">
        <div class="flex justify-between items-center p-4 bg-gray-900 text-white"><h2 id="game-viewer-title" class="text-xl font-bold"></h2><button id="close-game-viewer" class="rounded-full p-2 hover:bg-gray-700"><span class="material-symbols-outlined">close</span></button></div>
        <div class="flex-grow w-full h-full"><iframe id="game-iframe" class="w-full h-full border-0" allowfullscreen></iframe></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyBFGVAQCqkfwu2aurQNHB7sQ_hgHIfHqUc",
          authDomain: "gameo-x.firebaseapp.com",
          projectId: "gameo-x",
          storageBucket: "gameo-x.firebasestorage.app",
          messagingSenderId: "467997625131",
          appId: "1:467997625131:web:b883bf283b1d8d5b58936e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const profileLoggedIn = document.getElementById('profile-loggedIn');
        const profileLoggedOut = document.getElementById('profile-loggedOut');
        const loginContainer = document.getElementById('login-container');
        const signupContainer = document.getElementById('signup-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginError = document.getElementById('login-error');
        const signupError = document.getElementById('signup-error');
        const showSignupBtn = document.getElementById('show-signup');
        const showLoginBtn = document.getElementById('show-login');
        const logoutButton = document.getElementById('logout-button');
        const userEmailEl = document.getElementById('user-email');
        const searchBar = document.getElementById('search-bar');
        const gameViewerModal = document.getElementById('game-viewer-modal');
        const closeGameViewerBtn = document.getElementById('close-game-viewer');
        const gameViewerTitle = document.getElementById('game-viewer-title');
        const gameIframe = document.getElementById('game-iframe');
        
        let allGamesData = [];
        
        // --- App Initialization ---
        fetchAllData(); // Fetch data immediately on load

        const themeToggleBtn = document.getElementById('theme-toggle-main');
        const lightIcon = document.getElementById('theme-icon-light-main');
        const darkIcon = document.getElementById('theme-icon-dark-main');
        const applyTheme = (theme) => { if (theme === 'dark') { document.documentElement.classList.add('dark'); lightIcon.classList.add('hidden'); darkIcon.classList.remove('hidden'); } else { document.documentElement.classList.remove('dark'); lightIcon.classList.remove('hidden'); darkIcon.classList.add('hidden'); } };
        themeToggleBtn.addEventListener('click', () => { const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark'; localStorage.setItem('theme', newTheme); applyTheme(newTheme); });
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(savedTheme);
        
        const navLinks = document.querySelectorAll('.nav-link');
        const mainViews = document.querySelectorAll('.main-view');
        navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const targetViewId = `${link.dataset.view}-view`; mainViews.forEach(view => view.classList.add('hidden')); document.getElementById(targetViewId).classList.remove('hidden'); navLinks.forEach(l => { l.classList.remove('text-primary'); l.classList.add('text-muted-foreground'); }); link.classList.add('text-primary'); link.classList.remove('text-muted-foreground'); }); });

        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in
                profileLoggedIn.classList.remove('hidden');
                profileLoggedOut.classList.add('hidden');
                userEmailEl.textContent = user.email;
            } else {
                // User is signed out
                profileLoggedIn.classList.add('hidden');
                profileLoggedOut.classList.remove('hidden');
                // Ensure login form is visible by default when logged out
                signupContainer.classList.add('hidden'); 
                loginContainer.classList.remove('hidden');
            }
        });
        
        showSignupBtn.addEventListener('click', (e) => { e.preventDefault(); loginContainer.classList.add('hidden'); signupContainer.classList.remove('hidden'); });
        showLoginBtn.addEventListener('click', (e) => { e.preventDefault(); signupContainer.classList.add('hidden'); loginContainer.classList.remove('hidden'); });
        signupForm.addEventListener('submit', (e) => { e.preventDefault(); const email = signupForm['signup-email'].value; const password = signupForm['signup-password'].value; createUserWithEmailAndPassword(auth, email, password).catch(err => { signupError.textContent = err.message; signupError.classList.remove('hidden'); }); });
        loginForm.addEventListener('submit', (e) => { e.preventDefault(); const email = loginForm['login-email'].value; const password = loginForm['login-password'].value; signInWithEmailAndPassword(auth, email, password).catch(err => { loginError.textContent = 'Failed to sign in. Check email and password.'; loginError.classList.remove('hidden'); }); });
        logoutButton.addEventListener('click', () => signOut(auth));

        function fetchAllData() {
            const gamesQuery = query(collection(db, "games"), orderBy("createdAt", "desc"));
            onSnapshot(gamesQuery, snapshot => { allGamesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderGamesByCategories(allGamesData); renderAllGamesGrid(allGamesData); });
            
            const featuredQuery = query(collection(db, "featuredVideos"), orderBy("createdAt", "desc"));
            onSnapshot(featuredQuery, snapshot => { 
                const carousel = document.getElementById('featured-carousel');
                const grid = document.getElementById('featured-videos-grid');
                carousel.innerHTML = '';
                grid.innerHTML = '';
                
                if(snapshot.empty) {
                    const noContentView = `<p class="text-muted-foreground">No featured content yet.</p>`;
                    carousel.innerHTML = noContentView;
                    grid.innerHTML = noContentView;
                }
                
                snapshot.forEach(doc => {
                    const videoData = doc.data();
                    carousel.appendChild(createFeaturedCard(videoData, true)); // Create carousel card
                    grid.appendChild(createFeaturedCard(videoData, false)); // Create grid card
                });
            });

            const categoriesQuery = query(collection(db, "categories"), orderBy("name"));
            onSnapshot(categoriesQuery, snapshot => { const grid = document.getElementById('categories-grid'); grid.innerHTML = ''; if(snapshot.empty) grid.parentElement.classList.add('hidden'); else grid.parentElement.classList.remove('hidden'); snapshot.forEach(doc => grid.appendChild(createCategoryCard(doc.data()))); });
        }
        
        function createCategoryCard(category) {
            const card = document.createElement('div');
            const colors = ['bg-red-100 text-red-500', 'bg-blue-100 text-blue-500', 'bg-green-100 text-green-500', 'bg-yellow-100 text-yellow-500', 'bg-purple-100 text-purple-500', 'bg-pink-100 text-pink-500'];
            const colorClass = colors[Math.abs(category.name.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0)) % colors.length];
            card.className = 'flex flex-col items-center gap-2 rounded-xl bg-card p-4 text-center shadow-sm transition-transform hover:scale-105 cursor-pointer';
            card.innerHTML = `<div class="flex h-16 w-16 items-center justify-center rounded-full ${colorClass}"><span class="text-3xl">${category.icon}</span></div><h3 class="font-semibold text-card-foreground">${category.name}</h3>`;
            card.addEventListener('click', () => { searchBar.value = category.name; searchBar.dispatchEvent(new Event('input')); document.getElementById('home-view').classList.remove('hidden'); document.getElementById('games-view').classList.add('hidden'); navLinks.forEach(l => l.classList.remove('text-primary')); document.querySelector('[data-view="home"]').classList.add('text-primary'); });
            return card;
        }

        function createFeaturedCard(video, isCarousel) {
            const card = document.createElement('div');
            // Carousel items need specific width and snap classes
            card.className = isCarousel 
                ? 'w-72 flex-shrink-0 snap-center cursor-pointer group' 
                : 'cursor-pointer group'; // Grid items take up the grid space
            card.innerHTML = `<div class="relative mb-2 overflow-hidden rounded-2xl shadow-lg"><img alt="${video.title}" class="h-48 w-full object-cover transition-transform duration-300 group-hover:scale-110" src="${video.thumbnailUrl}"/><div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div><div class="absolute bottom-4 left-4"><h3 class="font-display text-xl text-white">${video.title}</h3></div></div>`;
            card.addEventListener('click', () => window.open(video.videoUrl, '_blank'));
            return card;
        }

        function renderGamesByCategories(games) {
            const container = document.getElementById('game-sections-container');
            container.innerHTML = '';
            const gamesByCategory = games.reduce((acc, game) => { const category = game.category || 'Other'; if (!acc[category]) acc[category] = []; acc[category].push(game); return acc; }, {});
            if (games.length === 0 && searchBar.value.length === 0) { container.innerHTML = `<p class="text-center text-muted-foreground mt-10">No games available right now.</p>`; return; }
            if (games.length === 0 && searchBar.value.length > 0) { container.innerHTML = `<p class="text-center text-muted-foreground mt-10">No games found for "${searchBar.value}".</p>`; return; }
            for (const category in gamesByCategory) { const section = document.createElement('section'); section.className = 'mb-8'; section.innerHTML = `<h2 class="mb-4 font-display text-2xl text-foreground">${category}</h2>`; const grid = document.createElement('div'); grid.className = 'grid grid-cols-2 gap-4'; gamesByCategory[category].forEach(game => grid.appendChild(createGameCard(game))); section.appendChild(grid); container.appendChild(section); }
        }

        function renderAllGamesGrid(games) {
            const grid = document.getElementById('all-games-grid');
            grid.innerHTML = '';
            if (games.length === 0) { grid.innerHTML = `<p class="text-muted-foreground col-span-2">No games found.</p>`; return; }
            games.forEach(game => grid.appendChild(createGameCard(game)));
        }
        
        function createGameCard(game) {
            const card = document.createElement('div');
            card.className = 'group cursor-pointer';
            card.innerHTML = `<div class="mb-2 overflow-hidden rounded-xl shadow-md"><img alt="${game.title}" class="aspect-square w-full object-cover transition-transform duration-300 group-hover:scale-105" src="${game.imageUrl}"></div><h3 class="font-bold text-card-foreground truncate">${game.title}</h3><p class="text-sm text-muted-foreground truncate">${game.description}</p>`;
            card.addEventListener('click', () => openGameViewer(game));
            return card;
        }
        
        searchBar.addEventListener('input', (e) => { 
            const searchTerm = e.target.value.toLowerCase(); 
            const filteredGames = allGamesData.filter(game => 
                game.title.toLowerCase().includes(searchTerm) || 
                (game.category && game.category.toLowerCase().includes(searchTerm))
            ); 
            renderGamesByCategories(filteredGames); 
            renderAllGamesGrid(filteredGames); 
        });
        
        function openGameViewer(game) { gameViewerTitle.textContent = game.title; gameIframe.src = game.gameUrl; gameViewerModal.classList.remove('hidden'); gameViewerModal.classList.add('flex'); }
        closeGameViewerBtn.addEventListener('click', () => { gameIframe.src = ''; gameViewerModal.classList.add('hidden'); gameViewerModal.classList.remove('flex'); });

    </script>
</body>
</html>